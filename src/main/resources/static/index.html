<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web SSH 企业版客户端 · STOMP 版</title>

    <!-- xterm.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <!-- STOMP + SockJS -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />

    <style>
        :root {
            --bg-0: #0f172a;
            --bg-1: #111827;
            --bg-2: #1f2937;
            --card: #0b1220;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --acc: #3b82f6;
            --acc-2: #22c55e;
            --danger: #ef4444;
            --warn: #f59e0b;
            --border: #1f2a44;
        }
        /* 亮色主题 */
        .theme-light {
            --bg-0: #f1f5f9;
            --bg-1: #e2e8f0;
            --bg-2: #cbd5e1;
            --card: #f8fafc;
            --muted: #64748b;
            --text: #1e293b;
            --acc: #3b82f6;
            --acc-2: #10b981;
            --danger: #ef4444;
            --warn: #f59e0b;
            --border: #cbd5e1;
        }
        .hidden { display: none !important; }
        #uploadModal:not(.hidden),
        #fileManagerModal:not(.hidden),
        #createDirModal:not(.hidden) {
            display: grid !important;
        }

        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* 防止页面级滚动 */
        }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
            "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text);
            background: radial-gradient(1200px 700px at 80% -10%, #1e293b 0%, #0b1020 60%, #060914 100%),
            linear-gradient(180deg, #0a0f1e, #0a0f1e);
        }
        body.theme-light {
            background: radial-gradient(1200px 700px at 80% -10%, #e2e8f0 0%, #cbd5e1 60%, #94a3b8 100%),
            linear-gradient(180deg, #f1f5f9, #f1f5f9);
        }
        .xterm { height: 100%; }
        .xterm-viewport { overflow-y: auto !important; }
        .xterm-screen { height: auto !important; }
        /* Layout */
        .shell {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100dvh;
            overflow: hidden; /* 防止shell容器滚动 */
        }
        .sidebar {
            background: linear-gradient(180deg, #0b1220, #050a17);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 防止侧边栏整体滚动 */
        }
        .theme-light .sidebar {
            background: linear-gradient(180deg, #f8fafc, #e2e8f0);
        }
        .brand {
            padding: 18px 18px 8px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .brand i { color: var(--acc); }
        .brand .title { font-weight: 700; letter-spacing: .3px; }
        .side-actions {
            padding: 12px 16px;
            display:flex;
            gap:8px;
            flex-shrink: 0;
        }

        .nav {
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            overflow-y: auto; /* 允许导航项滚动 */
        }
        .nav .item {
            display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius: 10px;
            color: var(--muted); cursor:pointer; transition: .2s ease;
            flex-shrink: 0;
        }
        .nav .item:hover { background: #0e1729; color: #cbd5e1; }
        .theme-light .nav .item:hover { background: #e2e8f0; color: #334155; }
        .nav .item.active { background: #0e1729; color: #e5e7eb; border: 1px solid #1a2440; }
        .theme-light .nav .item.active { background: #e2e8f0; color: #1e293b; border: 1px solid #cbd5e1; }

        .sidebar-footer {
            margin-top: auto;
            padding: 10px 14px;
            color: var(--muted);
            font-size: 12px;
            flex-shrink: 0;
        }

        .content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        .topbar {
            display:flex;
            align-items:center;
            justify-content: space-between;
            padding:14px 18px;
            border-bottom:1px solid var(--border);
            background: rgba(8,14,30,.7);
            backdrop-filter: blur(6px);
            flex-shrink: 0;
        }
        .theme-light .topbar {
            background: rgba(241, 245, 249, .7);
        }
        .topbar .right { display:flex; gap:8px; align-items:center; }

        .page {
            height: 100%;
            overflow: hidden; /* 关键修复：防止页面内容滚动 */
            display: flex;
            flex-direction: column;
        }

        /* Cards & forms */
        .card {
            background: rgba(8,14,30,.6);
            border:1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.35) inset, 0 2px 12px rgba(0,0,0,.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        .theme-light .card {
            background: rgba(248, 250, 252, .6);
            box-shadow: 0 10px 30px rgba(0,0,0,.1) inset, 0 2px 12px rgba(0,0,0,.1);
        }
        .card .card-hd {
            padding:16px 18px;
            border-bottom:1px solid var(--border);
            display:flex;
            align-items:center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .card .card-bd {
            padding:16px 18px;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .grid { display:grid; gap:16px; }
        .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
        .grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }

        .form-row {
            display:grid;
            grid-template-columns: 120px 1fr;
            align-items:center;
            gap:16px;
            margin-bottom: 10px;
        }
        label { color:#cbd5e1; font-size: 14px; }
        .theme-light label { color: #64748b; }
        input, select {
            width:100%;
            padding:12px 14px;
            border-radius: 12px;
            border:1px solid #1a2440;
            background:#0a1328;
            color:#e5e7eb;
            outline: none;
        }
        .theme-light input,
        .theme-light select {
            border:1px solid #cbd5e1;
            background:#f1f5f9;
            color:#1e293b;
        }
        input::placeholder { color:#6b7280; }
        .theme-light input::placeholder { color:#94a3b8; }

        .btn {
            display:inline-flex;
            align-items:center;
            gap:8px;
            padding:10px 14px;
            border-radius: 12px;
            border:1px solid transparent;
            cursor:pointer;
            font-weight:600;
            letter-spacing:.2px;
        }
        .btn:disabled { opacity:.6; cursor:not-allowed; }
        .btn.primary { background: linear-gradient(180deg, #2f68ff, #2a56d6); border-color:#284db7; }
        .btn.green { background: linear-gradient(180deg, #18c964, #0aa652); border-color:#0c8b47; }
        .btn.warn { background: linear-gradient(180deg, #f59e0b, #d97706); border-color:#b45309; }
        .btn.ghost { background: transparent; border-color:#1a2440; color:#cbd5e1; }
        .theme-light .btn.ghost { border-color:#cbd5e1; color:#64748b; }
        .btn.danger { background: linear-gradient(180deg, #ef4444, #b91c1c); border-color:#991b1b; }

        .toolbar { display:flex; gap:10px; flex-wrap: wrap; }

        .alert {
            padding: 10px 12px;
            border-radius: 12px;
            border:1px solid #1a2440;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .theme-light .alert {
            border:1px solid #cbd5e1;
        }
        .alert.info { background:#0b1933; color:#cfe1ff; }
        .theme-light .alert.info { background:#e0f2fe; color:#0369a1; }
        .alert.success { background:#0b2a1a; color:#caffd7; }
        .theme-light .alert.success { background:#dcfce7; color:#15803d; }
        .alert.warn { background:#2b210a; color:#ffe6b3; }
        .theme-light .alert.warn { background:#fef3c7; color:#d97706; }
        .alert.error { background:#2a0d0d; color:#ffd1d1; }
        .theme-light .alert.error { background:#fee2e2; color:#b91c1c; }

        /* Terminal layout - 修复滚动条问题 */
        .terminal-wrap {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        .tabs {
            display:flex;
            gap:6px;
            padding:8px;
            border-bottom:1px solid var(--border);
            background: rgba(7,12,25,.5);
            flex-shrink: 0;
        }
        .theme-light .tabs {
            background: rgba(241, 245, 249, .5);
        }
        .tab {
            display:flex;
            align-items:center;
            gap:8px;
            padding:8px 12px;
            border-radius: 12px;
            cursor:pointer;
            background: #091126;
            border:1px solid #1a2440;
            color:#d1d5db;
            flex-shrink: 0;
        }
        .theme-light .tab {
            background: #f1f5f9;
            border:1px solid #cbd5e1;
            color:#64748b;
        }
        .tab.active { background:#0d1a3b; color:#fff; box-shadow: 0 0 0 1px #23315b inset; }
        .theme-light .tab.active { background:#e2e8f0; color:#1e293b; box-shadow: 0 0 0 1px #94a3b8 inset; }
        .tab .close { opacity:.7; }

        .term-stage {
            position: relative;
            overflow: hidden;
            flex: 1;
            min-height: 0;
        }
        .term-pane {
            position:absolute;
            inset:0;
            display:none;
            height: 100%;
            width: 100%;
        }
        .term-pane.active { display:block; }

        /* 确保xterm终端正确显示 */
        .xterm { height: 100%; }
        .xterm-viewport { overflow-y: auto !important; }
        .xterm-screen { height: auto !important; }
        .term-pane.active { display:block; }

        .status {
            display:flex;
            justify-content: space-between;
            padding:8px 12px;
            border-top:1px solid var(--border);
            background: rgba(7,12,25,.6);
            color:#9ca3af;
            font-size:12px;
            flex-shrink: 0;
        }
        .theme-light .status {
            background: rgba(241, 245, 249, .6);
            color:#64748b;
        }

        /* File manager */
        .file-grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-grid {
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap:15px;
        }

        .file-card {
            background:#0a1328;
            border:1px solid #1a2440;
            border-radius:12px;
            padding:15px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .theme-light .file-card {
            background:#f1f5f9;
            border:1px solid #cbd5e1;
        }

        .file-card:hover {
            background: #1e293b;
            /*transform: translateY(-2px);*/
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .theme-light .file-card:hover {
            background: #e2e8f0;
        }

        .file-card .icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .file-card .name {
            font-size: 0.9em;
            word-break: break-all;
        }

        .file-card.directory .icon {
            color: var(--acc);
        }

        .file-card.file .icon {
            color: var(--muted);
        }

        /* 文件路径区域增强 */
        .file-path {
            padding: 10px 15px;
            background: rgba(30, 41, 59, 0.5);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-light .file-path {
            background: rgba(226, 232, 240, 0.5);
        }

        .file-path .path-container {
            flex: 1;
            min-width: 0; /* 允许内部文本溢出隐藏 */
        }

        .file-path .path-display {
            font-family: monospace;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer; /* 提示可点击 */
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .file-path .path-display:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .theme-light .file-path .path-display:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .file-path .path-input {
            font-family: monospace;
            font-size: 0.9em;
            width: 100%;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
        }

        .theme-light .file-path .path-input {
            border: 1px solid #cbd5e1;
            background: #f1f5f9;
            color: #1e293b;
        }

        /* 日志面板样式 (如果需要额外调整) */
        #logPanel {
            /* 样式已在 HTML 中定义，这里可以添加更多全局样式 */
        }
        .log-message {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .theme-light .log-message {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .log-timestamp {
            color: var(--muted);
            margin-right: 8px;
        }
        .theme-light .log-timestamp {
            color: #94a3b8;
        }
        .log-info { color: #93c5fd; }    /* 蓝色 */
        .theme-light .log-info { color: #3b82f6; }
        .log-success { color: #86efac; } /* 绿色 */
        .theme-light .log-success { color: #22c55e; }
        .log-warn { color: #fde047; }    /* 黄色 */
        .theme-light .log-warn { color: #eab308; }
        .log-error { color: #fca5a5; }   /* 红色 */
        .theme-light .log-error { color: #ef4444; }

        /* Utility */
        .mt-10{ margin-top:10px;} .mt-16{margin-top:16px;} .mt-20{margin-top:20px;}
        .hidden { display:none; }
        .text-right { text-align: right; }

        /* 修复滚动条的关键样式 */
        #page-ssh {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        #connection-panel {
            flex-shrink: 0;
            margin-bottom: 16px;
        }

        #terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        #terminal-container .card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #terminal-container .card-bd {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* SSH表单区域滚动修复 */
        #ssh-form-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
        }

        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 4px;
        }
        .theme-light ::-webkit-scrollbar-track {
            background: rgba(203, 213, 225, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        .theme-light ::-webkit-scrollbar-thumb {
            background: #94a3b8;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .theme-light ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* 自定义背景样式 */
        body.custom-bg-full {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed; /* 固定背景 */
        }
        body.custom-bg-full .shell {
            /* 可选：为主要内容添加半透明背景以提高可读性 */
            /* background-color: rgba(15, 23, 42, 0.8); */
        }

        .sidebar.custom-bg-sidebar {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* 可选：调整侧边栏背景的亮度/对比度 */
            /* filter: brightness(0.8); */
        }
        /* 确保侧边栏内容仍然可见 */
        .sidebar.custom-bg-sidebar .brand,
        .sidebar.custom-bg-sidebar .side-actions,
        .sidebar.custom-bg-sidebar .nav,
        .sidebar.custom-bg-sidebar .sidebar-footer {
            background-color: rgba(11, 18, 32, 0.7); /* 半透明背景 */
            /* 或者使用 backdrop-filter (如果浏览器支持) */
            /* backdrop-filter: blur(2px); background-color: rgba(11, 18, 32, 0.5); */
        }
        .theme-light .sidebar.custom-bg-sidebar .brand,
        .theme-light .sidebar.custom-bg-sidebar .side-actions,
        .theme-light .sidebar.custom-bg-sidebar .nav,
        .theme-light .sidebar.custom-bg-sidebar .sidebar-footer {
            background-color: rgba(248, 250, 252, 0.7);
        }

        /* 文件多选样式 */
        .file-card.selected {
            outline: 2px solid var(--acc); /* 使用主题色高亮选中项 */
            outline-offset: -2px;
            position: relative;
        }
        .file-card.selected::after {
            content: "";
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            background-color: var(--acc);
            border-radius: 50%;
            border: 2px solid var(--card);
            box-sizing: border-box;
        }
        /* 多选工具栏 */
        #fileMultiSelectToolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: rgba(30, 41, 59, 0.5);
            flex-wrap: wrap; /* 允许按钮换行 */
        }
        .theme-light #fileMultiSelectToolbar {
            background: rgba(226, 232, 240, 0.5);
        }
        #fileMultiSelectToolbar #selectedCount {
            flex-grow: 1; /* 让计数信息占据剩余空间 */
            min-width: 0; /* 允许文本溢出 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 文件信息模态框 (如果需要更复杂的显示) */
        #fileInfoModal .modal-content {
            max-width: 500px;
            height: 50%;
        }
        .file-info-grid {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 8px 16px;
            align-items: start;
        }
        .file-info-grid .label {
            font-weight: bold;
            text-align: right;
        }
        .file-info-grid .value {
            word-break: break-all;
        }

        /* 全屏终端模式 */
        .fullscreen-terminal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            /*background: #000;*/
        }

        .fullscreen-terminal .card {
            height: 100%;
            border-radius: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .fullscreen-terminal .card-hd {
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fullscreen-terminal .card-bd {
            padding: 0;
        }

        .fullscreen-terminal .terminal-wrap {
            height: calc(100% - 50px); /* 减去标题栏高度 */
        }

        .fullscreen-terminal .tabs {
            background: rgba(0, 0, 0, 0.7);
        }

        .fullscreen-terminal .status {
            background: rgba(0, 0, 0, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
            backdrop-filter: blur(2px);
            background: rgba(0,0,0,.35);
            z-index: 1001;
        }

        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.35);
            width: 95%;
            max-width: 1000px;
            height: 90vh;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .modal-body {
            padding: 0;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .modal-footer {
            padding: 16px 18px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        /* 文件操作菜单 */
        .file-context-menu {
            position: absolute;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1002;
            min-width: 150px;
            display: none;
        }

        .file-context-menu.show {
            display: block;
        }

        .file-context-menu .menu-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-context-menu .menu-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        /* 上传模态框特殊样式 */
        #uploadModal .modal-content,
        #createDirModal .modal-content {
            width: 90%;
            max-width: 520px;
            height: auto;
            max-height: 90vh;
        }
    </style>
</head>
<body>
<div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <i class="fas fa-terminal fa-lg"></i>
            <div>
                <div class="title">Web SSH</div>
                <div style="font-size:12px; color:var(--muted)">Enterprise · STOMP</div>
            </div>
        </div>

        <div class="side-actions">
            <button class="btn ghost" onclick="createNewTab()"><i class="fa fa-plus"></i> 新建标签</button>
            <button class="btn ghost" onclick="toggleTheme()"><i class="fa fa-moon"></i></button>
        </div>

        <nav class="nav">
            <div class="item active" data-page="ssh" onclick="switchPage('ssh', this)"><i class="fas fa-terminal"></i><span>SSH 连接</span></div>
            <div class="item" data-page="files" onclick="switchPage('files', this)"><i class="fas fa-folder"></i><span>文件管理</span></div>
            <div class="item" data-page="settings" onclick="switchPage('settings', this)"><i class="fas fa-gear"></i><span>设置</span></div>
        </nav>

        <div class="sidebar-footer">v1.0 · STOMP 客户端</div>
    </aside>

    <!-- Main -->
    <main class="content">
        <div class="topbar">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fa fa-server" style="color:var(--acc)"></i>
                <div>连接管理</div>
            </div>
            <div class="right">
                <span id="connState" class="alert info"><i class="fa fa-circle-notch fa-spin" style="display:none" id="stateSpin"></i><span id="stateText">未连接</span></span>
                <button class="btn ghost" onclick="refreshSaved()"><i class="fa fa-rotate"></i></button>
            </div>
        </div>

        <!-- Pages -->
        <section class="page" id="page-ssh">
            <!-- 连接面板 - 添加ID便于定位 -->
            <div id="connection-panel" class="grid cols-2" style="padding:16px; gap:16px;">
                <!-- Connection card -->
                <div class="card">
                    <div class="card-hd">
                        <div style="display:flex; align-items:center; gap:8px;"><i class="fa fa-plug"></i><b>SSH 连接面板</b></div>
                        <div class="toolbar">
                            <button class="btn primary" onclick="connectSSH()"><i class="fa fa-plug"></i> 连接</button>
                            <button class="btn green" onclick="testConnection()" id="testBtn"><i class="fa fa-vial"></i> 测试</button>
                            <button class="btn danger" onclick="disconnectSSH()" id="disconnectBtn" disabled><i class="fa fa-xmark"></i> 断开</button>
                        </div>
                    </div>
                    <div class="card-bd">
                        <!-- SSH表单区域滚动容器 -->
                        <div id="ssh-form-container">
                            <div class="grid cols-2">
                                <div class="form-row"><label>快速连接</label>
                                    <select id="savedServers" onchange="loadServerConfig()">
                                        <option value="">选择已保存的服务器...</option>
                                    </select>
                                </div>
                                <div class="form-row"><label>服务器名称</label><input id="serverName" placeholder="给这个连接起个名字"/></div>
                                <div class="form-row"><label>服务器地址</label><input id="host" placeholder="192.168.1.100 或 example.com" value="localhost"/></div>
                                <div class="form-row"><label>端口</label><input id="port" type="number" value="22"/></div>
                                <div class="form-row"><label>用户名</label><input id="username" placeholder="root"/></div>
                                <div class="form-row"><label>密码</label><input id="password" type="password" placeholder="••••••"/></div>
                            </div>
                            <div class="mt-10">
                                <button class="btn ghost" id="saveServerBtn" onclick="toggleSaveServer()">
                                    <i class="fa fa-bookmark"></i> 保存此服务器配置
                                </button>
                            </div>
<!--                            <div id="alertContainer" class="mt-16"></div>-->
                        </div>
                    </div>
                </div>

                <!-- Tips card -->
                <div class="card">
                    <div class="card-hd"><div style="display:flex; align-items:center; gap:8px;"><i class="fa fa-circle-info"></i><b>提示</b></div></div>
                    <div class="card-bd">
                        <div class="alert info"><i class="fa fa-shield"></i> 生产环境建议在服务端限制 <b>allowed origins</b>，前端仅通过 HTTPS 访问。</div>
                        <div class="alert warn mt-10"><i class="fa fa-triangle-exclamation"></i> 如果使用小程序或原生 WebSocket 客户端，建议关闭 SockJS，仅保留 ws/wss。</div>
                        <div class="alert success mt-10"><i class="fa fa-check"></i> 本页面已适配 STOMP：<code>/app/ssh/*</code> 收发，订阅 <code>/user/queue/output</code>。</div>
                    </div>
                </div>
            </div>

            <!-- Terminal - 修复滚动条问题 -->
            <!-- Terminal - 修复滚动条问题 -->
            <div id="terminal-container" style="padding: 0 16px 16px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="card-hd" style="justify-content: flex-start; gap:8px;">
                        <div class="toolbar">
                            <button class="btn ghost" onclick="createNewTab()"><i class="fa fa-plus"></i> 新建终端</button>
                            <button class="btn ghost" onclick="fitActiveTerminal()"><i class="fa fa-expand"></i> 全屏终端</button>
                            <button class="btn ghost" onclick="clearActive()"><i class="fa fa-eraser"></i> 清屏</button>
                            <!-- 添加切换日志显示的按钮 -->
                            <button class="btn ghost" onclick="toggleLogPanel()"><i class="fa fa-history"></i> 日志</button>
                        </div>
                    </div>
                    <!-- 添加日志面板 (默认隐藏) -->
                    <div id="logPanel" class="card-bd hidden" style="border-top: 1px solid var(--border); padding: 10px; height: 200px; overflow-y: auto; background: rgba(0,0,0,0.1);">
                        <div id="logMessages" style="font-family: monospace; font-size: 0.85em;"></div>
                    </div>
                    <!-- /添加日志面板 -->
                    <div class="card-bd" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <div class="terminal-wrap">
                            <div class="tabs" id="terminalTabs"></div>
                            <div class="term-stage" id="terminalStage"></div>
                            <div class="status"><span id="statusLeft">就绪</span><span id="statusRight">行: 24, 列: 80</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Files page -->
        <section class="page hidden" id="page-files">
            <div style="padding:16px; height: 100%; display: flex; flex-direction: column;">
                <div class="card" style="flex: 1; display: flex; flex-direction: column; height: 100%;">
                    <div class="card-hd">
                        <b>文件管理器</b>
                        <div class="toolbar">
                            <button class="btn primary" onclick="refreshFilesPage()"><i class="fa fa-sync"></i> 刷新服务器列表</button>
                        </div>
                    </div>
                    <div class="card-bd" style="display: flex; flex-direction: column; overflow: hidden;">
                        <div class="alert info">请选择一个已连接的服务器来管理文件。</div>
                        <div id="filesServerList" class="mt-16" style="flex: 1; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings page -->
        <section class="page hidden" id="page-settings">
            <div style="padding:16px;">
                <div class="card"><div class="card-hd"><b>设置</b></div><div class="card-bd">
                    <div class="form-row">
                        <label for="backgroundType">背景类型</label>
                        <select id="backgroundType">
                            <option value="default">默认</option>
                            <option value="sidebar">侧边栏背景</option>
                            <option value="full">全页面背景</option>
                        </select>
                    </div>
                    <div class="form-row" id="backgroundImageRow" style="display: none;">
                        <label for="backgroundImage">背景图片</label>
                        <input type="file" id="backgroundImage" accept="image/*" />
                        <div class="mt-10">
                            <button class="btn ghost" onclick="clearBackgroundImage()">清除背景图片</button>
                        </div>
                    </div>
                    <div class="mt-16 text-right">
                        <button class="btn primary" onclick="applySettings()">应用设置</button>
                    </div>
                    <div class="form-row">
                        <label for="terminalFontFamily">字体</label>
                        <select id="terminalFontFamily">
                            <option value="monospace">默认等宽字体</option>
                            <option value="'Fira Code', monospace">Fira Code</option>
                            <option value="Monaco, monospace">Monaco</option>
                            <option value="Consolas, monospace">Consolas</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label for="terminalFontSize">字体大小</label>
                        <input type="number" id="terminalFontSize" min="10" max="30" value="14" />
                    </div>
                    <div class="mt-16 text-right">
                        <button class="btn primary" onclick="applyTerminalSettings()">应用设置</button>
                    </div>
                </div></div>
            </div>
        </section>
    </main>
</div>

<!-- 文件管理器模态框 -->
<div id="fileManagerModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <b>文件管理器 - <span id="fileManagerServerName"></span></b>
            <button class="btn ghost" onclick="closeFileManager()"><i class="fa fa-times"></i></button>
        </div>
        <div id="fileMultiSelectToolbar" class="toolbar hidden" style="padding: 10px; border-bottom: 1px solid var(--border); background: rgba(30, 41, 59, 0.5);">
            <span id="selectedCount">已选择 0 项</span>
            <button class="btn danger" onclick="bulkDeleteSelectedFiles()"><i class="fa fa-trash"></i> 批量删除</button>
            <button class="btn primary" onclick="bulkDownloadSelectedFiles()"><i class="fa fa-download"></i> 批量下载</button>
            <button class="btn ghost" onclick="clearFileSelection()"><i class="fa fa-times"></i> 取消选择</button>
        </div>
        <div class="file-path">
            <button class="btn ghost" onclick="goToParentDirectory()"><i class="fa fa-arrow-up"></i> 上级</button>
            <!-- 修改路径显示区域 -->
            <div class="path-container">
                <div id="currentPathDisplay" class="path-display" title="点击跳转到路径">/</div>
                <input type="text" id="currentPathInput" class="path-input hidden" placeholder="输入路径..." />
            </div>
            <!-- /修改路径显示区域 -->
            <button class="btn ghost" onclick="refreshFileManager()"><i class="fa fa-sync"></i></button>
        </div>
        <div class="modal-body">
            <div id="fileGridContainer" class="file-grid-container">
                <div id="fileList" class="file-grid">
                    <!-- 文件列表将在这里动态生成 -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div>
                <button class="btn ghost" onclick="showCreateDirModal()"><i class="fa fa-folder-plus"></i> 新建目录</button>
            </div>
            <div class="file-actions">
                <button class="btn primary" onclick="showUploadModal()"><i class="fa fa-upload"></i> 上传文件</button>
            </div>
        </div>
    </div>
</div>
<!-- 文件信息模态框 -->
<div id="fileInfoModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <b id="fileInfoTitle">文件属性</b>
            <button class="btn ghost" onclick="closeFileInfoModal()"><i class="fa fa-times"></i></button>
        </div>
        <div class="modal-body" style="padding: 20px; overflow-y: auto;">
            <div class="file-info-grid">
                <span class="label">名称:</span>
                <span id="infoFileName" class="value">-</span>

                <span class="label">类型:</span>
                <span id="infoFileType" class="value">-</span>

                <span class="label">大小:</span>
                <span id="infoFileSize" class="value">-</span>

                <span class="label">修改时间:</span>
                <span id="infoFileModified" class="value">-</span>

                <span class="label">权限:</span>
                <span id="infoFilePermissions" class="value">-</span>
            </div>
        </div>
        <div class="modal-footer" style="padding: 16px; border-top: 1px solid var(--border); text-align: right;">
            <button class="btn primary" onclick="closeFileInfoModal()">关闭</button>
        </div>
    </div>
</div>
<!-- 上传文件模态框 -->
<div id="uploadModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <b>上传文件</b>
            <button class="btn ghost" onclick="closeUploadModal()"><i class="fa fa-xmark"></i></button>
        </div>
        <div class="modal-body" style="padding: 16px 18px;">
            <div class="grid">
                <div class="form-row"><label>选择文件</label><input id="uploadFiles" type="file" multiple /></div>
                <div class="form-row"><label>上传路径</label><input id="uploadPath" value="/" /></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn ghost" onclick="closeUploadModal()">取消</button>
            <button class="btn primary" onclick="handleUpload()">上传</button>
        </div>
    </div>
</div>

<!-- 新建目录模态框 -->
<div id="createDirModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <b>新建目录</b>
            <button class="btn ghost" onclick="closeCreateDirModal()"><i class="fa fa-times"></i></button>
        </div>
        <div class="modal-body" style="padding: 16px 18px;">
            <div class="form-row">
                <label>目录名称</label>
                <input id="newDirName" placeholder="请输入目录名称" />
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn ghost" onclick="closeCreateDirModal()">取消</button>
            <button class="btn primary" onclick="createDirectory()">创建</button>
        </div>
    </div>
</div>

<!-- 文件操作上下文菜单 -->
<div id="fileContextMenu" class="file-context-menu">
    <div class="menu-item" onclick="downloadSelectedFile()"><i class="fa fa-download"></i> 下载</div>
    <div class="menu-item" onclick="deleteSelectedFile()"><i class="fa fa-trash"></i> 删除</div>
    <div class="menu-item" onclick="renameSelectedFile()"><i class="fa fa-edit"></i> 重命名</div>
    <div class="menu-item" onclick="showFileInfo()"><i class="fa fa-info-circle"></i> 属性</div>
</div>

<script>
    // ===== State =====
    let stompClient = null;
    let connected = false;
    let isFullscreen = false;
    let currentFileManagerServer = null; // 当前文件管理器连接的服务器
    let currentPath = "/";               // 当前浏览路径
    let selectedFile = null;             // 当前选中的文件/目录信息

    const tabs = []; // {id, name, term, fitAddon}
    let activeTab = null;
    let selectedFiles = new Set(); // 用于存储多选的文件名
    let lastSelectedFile = null; // 用于 Shift 选择

    // ===== UI helpers =====
    function switchPage(page, el) {
        document.querySelectorAll('.nav .item').forEach(n => n.classList.remove('active'));
        if (el) el.classList.add('active');
        ['ssh','files','settings'].forEach(p => {
            const sec = document.getElementById('page-'+p);
            if (!sec) return;
            if (p === page) { sec.classList.remove('hidden'); } else { sec.classList.add('hidden'); }
        });

        // 如果切换到文件页面，刷新服务器列表
        if (page === 'files') {
            refreshFilesPage();
        }
    }

    const TERMINAL_THEMES = {
        dark: {
            background: '#0b0f1e',
            foreground: '#e5e7eb',
            cursor: '#e5e7eb',
            cursorAccent: '#0b0f1e',
            selection: 'rgba(59, 130, 246, 0.3)', // #3b82f6 with alpha
            black: '#000000',
            red: '#ef4444',
            green: '#22c55e',
            yellow: '#f59e0b',
            blue: '#3b82f6',
            magenta: '#8b5cf6',
            cyan: '#06b6d4',
            white: '#e5e7eb',
            brightBlack: '#64748b',
            brightRed: '#f87171',
            brightGreen: '#4ade80',
            brightYellow: '#fbbf24',
            brightBlue: '#60a5fa',
            brightMagenta: '#a78bfa',
            brightCyan: '#22d3ee',
            brightWhite: '#f8fafc'
        },
        light: {
            background: '#f1f5f9',
            foreground: '#1e293b',
            cursor: '#1e293b',
            cursorAccent: '#f1f5f9',
            selection: 'rgba(147, 197, 253, 0.3)', // #93c5fd with alpha
            black: '#000000',
            red: '#ef4444',
            green: '#10b981',
            yellow: '#f59e0b',
            blue: '#3b82f6',
            magenta: '#8b5cf6',
            cyan: '#0891b2',
            white: '#1e293b',
            brightBlack: '#94a3b8',
            brightRed: '#f87171',
            brightGreen: '#34d399',
            brightYellow: '#fbbf24',
            brightBlue: '#60a5fa',
            brightMagenta: '#a78bfa',
            brightCyan: '#06b6d4',
            brightWhite: '#0f172a'
        }
    };

    function toggleTheme(){
        document.body.classList.toggle('theme-light');
        const themeIcon = document.querySelector('.side-actions .btn.ghost i');
        if (document.body.classList.contains('theme-light')) {
            themeIcon.className = 'fa fa-sun';
        } else {
            themeIcon.className = 'fa fa-moon';
        }
        const isLight = document.body.classList.contains('theme-light');
        localStorage.setItem('webssh-theme', isLight ? 'light' : 'dark');

        // --- 使用新的主题配置 ---
        const newTheme = isLight ? TERMINAL_THEMES.light : TERMINAL_THEMES.dark;
        tabs.forEach(tab => {
            if (tab.term) {
                // 使用 options.theme 而不是 setOption
                tab.term.options.theme = newTheme;
            }
        });
        applyBackgroundSettings();
    }

    function applyBackgroundSettings() {
        const bgType = localStorage.getItem('webssh-bg-type') || 'default';
        const bgImage = localStorage.getItem('webssh-bg-image'); // 存储的是 Data URL

        const body = document.body;
        const sidebar = document.querySelector('.sidebar');

        // 移除所有自定义背景类
        body.classList.remove('custom-bg-full');
        sidebar.classList.remove('custom-bg-sidebar');
        body.style.backgroundImage = '';
        sidebar.style.backgroundImage = '';

        if (bgType !== 'default' && bgImage) {
            if (bgType === 'full') {
                body.classList.add('custom-bg-full');
                body.style.backgroundImage = `url(${bgImage})`;
            } else if (bgType === 'sidebar') {
                sidebar.classList.add('custom-bg-sidebar');
                sidebar.style.backgroundImage = `url(${bgImage})`;
            }
        }
    }

    // --- 新增：清除背景图片 ---
    function clearBackgroundImage() {
        localStorage.removeItem('webssh-bg-image');
        localStorage.setItem('webssh-bg-type', 'default');
        document.getElementById('backgroundType').value = 'default';
        document.getElementById('backgroundImageRow').style.display = 'none';
        applyBackgroundSettings();
        alertOk('背景图片已清除');
    }

    // --- 新增：应用所有设置 ---
    function applySettings() {
        // 应用主题 (已在 toggleTheme 中处理，这里调用是为了确保逻辑一致)
        // const isLight = document.body.classList.contains('theme-light');
        // localStorage.setItem('webssh-theme', isLight ? 'light' : 'dark');

        // 应用背景设置
        const bgType = document.getElementById('backgroundType').value;
        localStorage.setItem('webssh-bg-type', bgType);

        const fileInput = document.getElementById('backgroundImage');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                localStorage.setItem('webssh-bg-image', dataUrl);
                applyBackgroundSettings();
                alertOk('设置已应用');
            };
            reader.readAsDataURL(file);
        } else {
            // 如果没有选择新文件，仅应用类型设置
            applyBackgroundSettings();
            alertOk('设置已应用');
        }
    }

    function setConnState(text, spinning=false) {
        document.getElementById('stateText').textContent = text;
        document.getElementById('stateSpin').style.display = spinning ? 'inline-block' : 'none';
        const pill = document.getElementById('connState');
        pill.classList.remove('error','success','info');
        pill.classList.add(spinning ? 'info' : (connected? 'success' : 'error'));
    }

    // ===== Saved servers (localStorage) =====
    const KEY = 'webssh.savedServers.v1';
    function refreshSaved(){ loadSavedServers(); alertInfo('已刷新已保存服务器列表'); }
    function loadSavedServers(){
        const list = JSON.parse(localStorage.getItem(KEY) || '[]');
        const sel = document.getElementById('savedServers');
        sel.innerHTML = '<option value="">选择已保存的服务器...</option>';
        list.forEach((s, idx) => {
            const o = document.createElement('option');
            o.value = idx; o.textContent = `${s.name || s.host}:${s.port} (${s.username})`;
            sel.appendChild(o);
        });
    }
    function loadServerConfig() {
        const sel = document.getElementById('savedServers');
        const idx = sel.selectedIndex;
        if (idx <= 0) return;
        const list = JSON.parse(localStorage.getItem(KEY) || '[]');
        const server = list[idx - 1]; // 第一个选项是提示，所以减1
        document.getElementById('host').value = server.host;
        document.getElementById('port').value = server.port || 22;
        document.getElementById('username').value = server.username;
        document.getElementById('password').value = server.password || '';
        document.getElementById('serverName').value = server.name || '';
        alertOk('已加载服务器配置');
    }

    // --- 新增：日志面板控制 ---
    function toggleLogPanel() {
        const logPanel = document.getElementById('logPanel');
        if (logPanel) { // 安全检查
            logPanel.classList.toggle('hidden');
            if (!logPanel.classList.contains('hidden')) {
                const logMessages = document.getElementById('logMessages');
                if (logMessages) {
                    logMessages.scrollTop = logMessages.scrollHeight;
                }
            }
        }
    }

    // --- 新增：添加日志到面板 ---
    function addLogToPanel(type, msg) {
        const logPanel = document.getElementById('logPanel');
        const logMessages = document.getElementById('logMessages');
        // 只有当日志面板存在时才添加日志
        if (logPanel && logMessages) {
            const now = new Date();
            const timestamp = `[${now.toLocaleTimeString()}]`;

            const logEntry = document.createElement('div');
            logEntry.className = `log-message log-${type}`;
            logEntry.innerHTML = `<span class="log-timestamp">${timestamp}</span> ${msg}`;

            logMessages.appendChild(logEntry);

            const maxLogs = 100;
            while (logMessages.children.length > maxLogs) {
                logMessages.removeChild(logMessages.firstChild);
            }

            logMessages.scrollTop = logMessages.scrollHeight;
        }
        // 如果没有日志面板，则静默忽略
    }

    // --- 修改：Alert 函数现在也写入日志面板 ---
    function alertInfo(msg) {
        // 可以保留短暂提示，或者移除
        console.log("[INFO]", msg); // 至少在控制台记录
        addLogToPanel('info', msg); // 如果有日志面板则添加
    }
    function alertOk(msg) {
        console.log("[OK]", msg);
        addLogToPanel('success', msg);
    }
    function alertWarn(msg) {
        // pushAlert('warn', msg);
        console.warn("[WARN]", msg);
        addLogToPanel('warn', msg);
    }
    function alertErr(msg) {
        // pushAlert('error', msg);
        console.error("[ERROR]", msg);
        addLogToPanel('error', msg);
    }

    // ===== STOMP connect / flow =====
    function ensureStompConnected(onReady){
        if (stompClient && connected) return onReady && onReady();
        setConnState('正在连接...', true);
        const socket = new SockJS('/ssh-ws');
        stompClient = Stomp.over(socket);
        // 生产建议：stompClient.debug = null;
        stompClient.connect({}, () => {
            connected = true;
            setConnState('已连接');
            // 订阅服务端输出
            stompClient.subscribe('/user/queue/output', (msg) => {
                try {
                    const body = JSON.parse(msg.body);
                    if (body.type === 'output' && body.data != null) appendOutput(body.data);
                    if (body.type === 'connected') alertOk(body.message || 'SSH 连接建立成功');
                    if (body.type === 'error') alertErr(body.message || '错误');
                } catch(e) { console.error(e); }
            });
            if (onReady) onReady();
        }, (err) => {
            connected = false;
            setConnState('连接失败');
            alertErr('STOMP 连接失败：' + (err && err.body || err));
        });
    }

    function connectSSH(){
        const host = document.getElementById('host').value.trim();
        const port = parseInt(document.getElementById('port').value, 10) || 22;
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!host || !username) { return alertWarn('请填写主机与用户名'); }
        ensureStompConnected(() => {
            stompClient.send('/app/ssh/connect', {}, JSON.stringify({ host, port, username, password }));
            document.getElementById('disconnectBtn').disabled = false;
            // 保存服务器配置（异步处理）
            saveServerIfNeeded(host, port, username, password).then(() => {
                if (!activeTab) createNewTab();
            });
        });
    }

    // 保存服务器配置状态
    let saveServerEnabled = false;
    function toggleSaveServer() {
        saveServerEnabled = !saveServerEnabled;
        const btn = document.getElementById('saveServerBtn');
        if (saveServerEnabled) {
            btn.classList.remove('ghost');
            btn.classList.add('primary');
            btn.innerHTML = '<i class="fa fa-bookmark"></i> 已启用保存到服务器';
        } else {
            btn.classList.remove('primary');
            btn.classList.add('ghost');
            btn.innerHTML = '<i class="fa fa-bookmark"></i> 保存到服务器';
        }
    }

    // 保存到本地存储
    function saveToLocal(host, port, username, password){
        const list = JSON.parse(localStorage.getItem(KEY) || '[]');
        const name = document.getElementById('serverName').value;
        list.push({ host, port, username, password, name });
        localStorage.setItem(KEY, JSON.stringify(list));
        loadSavedServers();
        alertOk('已保存到本地');
    }

    // 保存到服务器
    async function saveToServer(host, port, username, password) {
        try {
            const name = document.getElementById('serverName').value;
            const serverData = {
                name: name || `${host}:${port}`,
                host,
                port,
                username,
                password
            };
            const response = await fetch('/api/servers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(serverData)
            });
            const result = await response.json();
            if (result.success) {
                alertOk('已保存到服务器');
                // 同时也保存到本地作为备份
                saveToLocal(host, port, username, password);
                return true;
            } else {
                alertErr('保存到服务器失败: ' + result.message);
                return false;
            }
        } catch (error) {
            alertErr('保存到服务器失败: ' + error.message);
            // 出错时仍然保存到本地
            saveToLocal(host, port, username, password);
            return false;
        }
    }

    function saveServerIfNeeded(host, port, username, password){
        if (!saveServerEnabled) return Promise.resolve();
        // 优先保存到服务器，失败时保存到本地
        return saveToServer(host, port, username, password);
    }

    function disconnectSSH(){
        if (!stompClient) return;
        stompClient.send('/app/ssh/disconnect', {}, JSON.stringify({}));
        document.getElementById('disconnectBtn').disabled = true;
        alertInfo('已发送断开请求');
    }

    async function testConnection() {
        const host = document.getElementById('host').value.trim();
        const port = parseInt(document.getElementById('port').value, 10) || 22;
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!host || !username) return alertWarn('请填写主机与用户名');
        try {
            const res = await fetch('/api/servers/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host, port, username, password })
            });
            const data = await res.json();
            if (data.success) {
                alertOk('连接测试成功');
            } else {
                alertErr('连接测试失败: ' + data.message);
            }
        } catch (err) {
            alertErr('请求失败: ' + err.message);
        }
    }

    async function fetchServers() {
        try {
            const res = await fetch('/api/servers');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const servers = await res.json();

            // === 添加这部分：将远程服务器填充到首页下拉列表 ===
            // 注意：这里需要决定是 *替换* 本地列表还是 *合并* 本地列表
            // 当前逻辑：用远程列表替换下拉列表内容
            const sel = document.getElementById('savedServers');
            if (sel) { // 确保元素存在
                sel.innerHTML = '<option value="">选择已保存的服务器...</option>';
                servers.forEach((s, idx) => {
                    // 注意：这里的 value 和 loadSavedServers 略有不同，
                    // 可以用索引，也可以用服务器ID，关键是要和 loadServerConfig 匹配
                    // 这里暂时用索引加一个偏移量来区分远程和本地？或者用不同的标识？
                    // 简单起见，先用索引，但 loadServerConfig 需要能处理
                    // 更好的方式可能是统一数据结构或在 option 上加属性标识来源
                    const opt = document.createElement('option');
                    opt.value = `remote_${s.id}`; // 使用 remote_ 前缀和服务器ID区分
                    opt.textContent = `${s.name || s.host}:${s.port} (${s.username})`;
                    opt.dataset.server = JSON.stringify(s); // 存储完整数据
                    sel.appendChild(opt);
                });
            }
            // ======================================================

            return servers;
        } catch (err) {
            console.error('加载服务器列表失败:', err);
            alertErr('无法连接服务器列表: ' + err.message);
            // 失败时仍可加载本地缓存
            loadSavedServers(); // 回退到加载本地
            return []; // 返回空数组
        }
    }

    // ===== Xterm tabs =====
    function createNewTab(name){
        const tabId = 'tab-' + Date.now();
        const terminalSettings = loadTerminalSettings();
        // 创建终端时不设置 theme
        const term = new Terminal({
            cursorBlink: true,
            fontSize: terminalSettings.fontSize,
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        // --- 新增：根据当前全局主题立即设置终端主题 ---
        const isLight = document.body.classList.contains('theme-light');
        term.options.theme = isLight ? TERMINAL_THEMES.light : TERMINAL_THEMES.dark; // 应用初始主题

        // Tabs UI
        const tabEl = document.createElement('div');
        tabEl.className = 'tab active';
        tabEl.dataset.id = tabId;
        tabEl.innerHTML = `<i class="fa fa-terminal"></i><span>${name || 'SSH'}</span> <i class="fa fa-xmark close"></i>`;
        tabEl.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('close')) { closeTab(tabId); e.stopPropagation(); return; }
            activateTab(tabId);
        });
        document.getElementById('terminalTabs').appendChild(tabEl);

        const pane = document.createElement('div');
        pane.className = 'term-pane';
        pane.id = tabId;
        document.getElementById('terminalStage').appendChild(pane);

        term.open(pane);
        fitAddon.fit();

        // 输入 → 发送到后端
        term.onData(data => {
            if (stompClient && connected) {
                stompClient.send('/app/ssh/input', {}, JSON.stringify({ data }));
            }
        });

        tabs.push({ id: tabId, name: name || 'SSH', term, fitAddon });
        activateTab(tabId);

        // 添加resize监听，确保终端适应窗口
        window.addEventListener('resize', () => {
            if (isFullscreen) {
                fitAddon.fit();
            } else {
                fitActiveTerminal();
            }
            updateStatus(term);
            // 可选：告诉后端窗口大小
            if (stompClient && connected) {
                stompClient.send('/app/ssh/resize', {}, JSON.stringify({ cols: term.cols, rows: term.rows }));
            }
        });
    }

    function activateTab(tabId){
        activeTab = tabId;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.id === tabId));
        document.querySelectorAll('.term-pane').forEach(p => p.classList.toggle('active', p.id === tabId));
        const t = tabs.find(x => x.id === tabId);
        if (t) {
            t.fitAddon.fit();
            updateStatus(t.term);
        }
    }

    function closeTab(tabId){
        const idx = tabs.findIndex(x => x.id === tabId);
        if (idx === -1) return;
        const t = tabs[idx];
        t.term.dispose();
        document.querySelector(`.tab[data-id="${tabId}"]`)?.remove();
        document.getElementById(tabId)?.remove();
        tabs.splice(idx,1);
        if (activeTab === tabId) {
            if (tabs.length) activateTab(tabs[tabs.length-1].id); else activeTab = null;
        }
    }

    // 全屏终端功能
    function fitActiveTerminal(){
        const t = getActive();
        if (!t) return;
        // 如果当前是全屏模式，直接适配全屏
        if (isFullscreen) {
            t.fitAddon.fit();
            updateStatus(t.term);
            return;
        }
        // 否则适配当前窗口
        t.fitAddon.fit();
        updateStatus(t.term);
        // 发送窗口大小调整消息到后端
        if (stompClient && connected) {
            stompClient.send('/app/ssh/resize', {}, JSON.stringify({
                cols: t.term.cols,
                rows: t.term.rows
            }));
        }
    }

    // 切换全屏模式
    function toggleFullscreen() {
        const terminalContainer = document.getElementById('terminal-container');
        if (!isFullscreen) {
            // 进入全屏模式
            terminalContainer.classList.add('fullscreen-terminal');
            document.querySelector('[onclick="fitActiveTerminal()"]').innerHTML = '<i class="fa fa-compress"></i> 退出全屏';
            isFullscreen = true;
        } else {
            // 退出全屏模式
            terminalContainer.classList.remove('fullscreen-terminal');
            document.querySelector('[onclick="fitActiveTerminal()"]').innerHTML = '<i class="fa fa-expand"></i> 全屏终端';
            isFullscreen = false;
        }
        // 适配终端大小
        setTimeout(() => {
            const t = getActive();
            if (t) {
                t.fitAddon.fit();
                updateStatus(t.term);
                // 发送窗口大小调整消息到后端
                if (stompClient && connected) {
                    stompClient.send('/app/ssh/resize', {}, JSON.stringify({
                        cols: t.term.cols,
                        rows: t.term.rows
                    }));
                }
            }
        }, 100);
    }

    function clearActive(){
        const t = getActive();
        if (!t) return;
        t.term.clear();
    }

    function getActive(){
        return tabs.find(x => x.id === activeTab);
    }

    function appendOutput(text){
        const t = getActive();
        if (!t) return;
        t.term.write(text);
        updateStatus(t.term);
    }

    function updateStatus(term){
        document.getElementById('statusLeft').textContent = connected ? '在线' : '离线';
        document.getElementById('statusRight').textContent = `行: ${term.rows}, 列: ${term.cols}`;
    }

    // ===== 文件管理功能 (优化版) =====

    // 预定义文件类型图标映射 (提升性能)
    const FILE_TYPE_ICONS = {
        // 图片
        'image': ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'],
        // 文档
        'document': ['txt', 'log', 'md', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'],
        // 压缩包
        'archive': ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'],
        // 视频
        'video': ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv', 'webm'],
        // 音频
        'audio': ['mp3', 'wav', 'flac', 'aac', 'ogg', 'm4a'],
        // 代码
        'code': ['js', 'ts', 'html', 'css', 'java', 'py', 'cpp', 'c', 'h', 'php', 'rb', 'go', 'rs', 'sh', 'sql']
    };

    // 获取文件图标类名
    function getFileIconClass(filename, isDirectory) {
        if (isDirectory) {
            return 'fa fa-folder';
        }

        const ext = filename.split('.').pop().toLowerCase();
        for (const [type, extensions] of Object.entries(FILE_TYPE_ICONS)) {
            if (extensions.includes(ext)) {
                switch (type) {
                    case 'image': return 'fa fa-image';
                    case 'document': return 'fa fa-file-alt';
                    case 'archive': return 'fa fa-file-archive';
                    case 'video': return 'fa fa-file-video';
                    case 'audio': return 'fa fa-file-audio';
                    case 'code': return 'fa fa-file-code';
                    default: break; // 继续循环
                }
            }
        }
        // 默认文件图标
        return 'fa fa-file';
    }

    // 为特定服务器打开文件管理器
    function openFileManagerForServer(server) {
        currentFileManagerServer = server;
        document.getElementById('fileManagerServerName').textContent = server.name || `${server.host}:${server.port}`;
        currentPath = "/";
        updatePathDisplay(currentPath); // 更新路径显示
        document.getElementById('fileManagerModal').classList.remove('hidden');
        listFiles();
    }

    // 更新路径显示
    function updatePathDisplay(path) {
        const displayElement = document.getElementById('currentPathDisplay');
        const inputElement = document.getElementById('currentPathInput');
        displayElement.textContent = path;
        displayElement.title = `点击跳转到: ${path}`;
        inputElement.value = path; // 同步输入框值
    }

    // 激活路径输入框
    function activatePathInput() {
        const displayElement = document.getElementById('currentPathDisplay');
        const inputElement = document.getElementById('currentPathInput');
        displayElement.classList.add('hidden');
        inputElement.classList.remove('hidden');
        inputElement.focus();
        inputElement.select(); // 选中所有文本方便编辑
    }

    // 停用路径输入框
    function deactivatePathInput() {
        const displayElement = document.getElementById('currentPathDisplay');
        const inputElement = document.getElementById('currentPathInput');
        displayElement.classList.remove('hidden');
        inputElement.classList.add('hidden');
    }

    // 列出文件 (优化版)
    async function listFiles(path = currentPath) {
        if (!currentFileManagerServer) {
            alertErr('未选择服务器');
            return;
        }
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '<div class="alert info">正在加载文件列表...</div>';

        currentPath = path;
        updatePathDisplay(currentPath);

        // 清除之前的多选状态
        selectedFiles.clear();
        lastSelectedFile = null;
        updateMultiSelectToolbar();

        try {
            const response = await fetch(`/api/servers/${currentFileManagerServer.id}/files?path=${encodeURIComponent(path)}`);
            const result = await response.json();
            if (!result.success) {
                fileList.innerHTML = `<div class="alert error">加载失败: ${result.message}</div>`;
                return;
            }
            const files = result.data || [];
            displayFilesOptimized(files);
        } catch (error) {
            fileList.innerHTML = `<div class="alert error">请求失败: ${error.message}</div>`;
        }
    }

    // 文件列表显示函数，支持多选
    function displayFilesOptimized(files) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';
        if (files.length === 0) {
            fileList.innerHTML = '<div class="alert info">此目录为空</div>';
            updateMultiSelectToolbar(); // 确保工具栏状态正确
            return;
        }

        const fragment = document.createDocumentFragment();
        files.forEach(file => {
            const card = document.createElement('div');
            card.className = `file-card ${file.isDirectory ? 'directory' : 'file'}`;
            card.dataset.name = file.name;
            card.dataset.isDirectory = file.isDirectory;
            // 添加数据属性存储详细信息 (如果后端提供了)
            if (file.size !== undefined) card.dataset.size = file.size;
            if (file.lastModified) card.dataset.lastModified = file.lastModified;
            if (file.permissions) card.dataset.permissions = file.permissions;

            const iconClass = getFileIconClass(file.name, file.isDirectory);
            card.innerHTML = `
            <div class="icon"><i class="${iconClass}"></i></div>
            <div class="name">${file.name}</div>
        `;
            fragment.appendChild(card);
        });
        fileList.appendChild(fragment);

        // 更新选中状态 (如果之前有选中)
        updateFileCardSelectionUI();

        // 使用事件委托处理点击、右键菜单和多选
        fileList.removeEventListener('click', handleFileClick);
        fileList.removeEventListener('contextmenu', handleFileContextMenu);
        fileList.addEventListener('click', handleFileClick);
        fileList.addEventListener('contextmenu', handleFileContextMenu);
    }

    // 文件点击事件处理函数 (事件委托)
    function handleFileClick(e) {
        document.getElementById('fileContextMenu').classList.remove('show');

        let targetCard = e.target.closest('.file-card');
        if (!targetCard) return;

        const filename = targetCard.dataset.name;
        const isCtrlPressed = e.ctrlKey || e.metaKey; // 兼容 Mac
        const isShiftPressed = e.shiftKey;

        if (isShiftPressed && lastSelectedFile) {
            // Shift 选择: 选择从 lastSelectedFile 到当前文件的范围
            performShiftSelect(filename);
        } else if (isCtrlPressed) {
            // Ctrl 选择: 切换单个文件选中状态
            if (selectedFiles.has(filename)) {
                selectedFiles.delete(filename);
            } else {
                selectedFiles.add(filename);
            }
            lastSelectedFile = filename;
        } else {
            // 普通点击: 清除之前选择，只选中当前文件
            selectedFiles.clear();
            selectedFiles.add(filename);
            lastSelectedFile = filename;
        }

        updateFileCardSelectionUI();
        updateMultiSelectToolbar();
    }

    // 执行 Shift 选择
    function performShiftSelect(currentFilename) {
        const allCards = Array.from(document.querySelectorAll('#fileList .file-card'));
        const allNames = allCards.map(card => card.dataset.name);
        const lastIndex = allNames.indexOf(lastSelectedFile);
        const currentIndex = allNames.indexOf(currentFilename);

        if (lastIndex === -1 || currentIndex === -1) return; // 安全检查

        const [start, end] = lastIndex < currentIndex ? [lastIndex, currentIndex] : [currentIndex, lastIndex];

        selectedFiles.clear();
        for (let i = start; i <= end; i++) {
            selectedFiles.add(allNames[i]);
        }
    }

    // 更新文件卡片的 UI 选中状态
    function updateFileCardSelectionUI() {
        document.querySelectorAll('#fileList .file-card').forEach(card => {
            const name = card.dataset.name;
            if (selectedFiles.has(name)) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }

    // 更新多选工具栏
    function updateMultiSelectToolbar() {
        const toolbar = document.getElementById('fileMultiSelectToolbar');
        const countSpan = document.getElementById('selectedCount');
        const count = selectedFiles.size;

        if (count > 0) {
            toolbar.classList.remove('hidden');
            countSpan.textContent = `已选择 ${count} 项`;
        } else {
            toolbar.classList.add('hidden');
            countSpan.textContent = '已选择 0 项';
        }
    }

    // 清除文件选择
    function clearFileSelection() {
        selectedFiles.clear();
        lastSelectedFile = null;
        updateFileCardSelectionUI();
        updateMultiSelectToolbar();
        document.getElementById('fileContextMenu').classList.remove('show');
    }

    // 批量删除
    async function bulkDeleteSelectedFiles() {
        if (selectedFiles.size === 0 || !currentFileManagerServer) {
            alertWarn('请先选择文件或目录');
            return;
        }

        const count = selectedFiles.size;
        if (!confirm(`确定要删除选中的 ${count} 项吗?`)) {
            return;
        }

        let successCount = 0;
        let failCount = 0;
        const errors = [];

        // 创建一个包含所有删除 Promise 的数组
        const deletePromises = Array.from(selectedFiles).map(filename => {
            const fullPath = currentPath === '/' ? `/${filename}` : `${currentPath}/${filename}`;
            const isDirectory = document.querySelector(`.file-card[data-name="${CSS.escape(filename)}"]`).dataset.isDirectory === 'true';

            return fetch(`/api/servers/${currentFileManagerServer.id}/file`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: fullPath, isDirectory: isDirectory })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                        errors.push(`${filename}: ${result.message}`);
                    }
                })
                .catch(error => {
                    failCount++;
                    errors.push(`${filename}: ${error.message}`);
                });
        });

        try {
            // 等待所有删除操作完成
            await Promise.all(deletePromises);

            if (failCount === 0) {
                alertOk(`成功删除 ${successCount} 项`);
            } else {
                const errorMsg = `删除完成。成功: ${successCount}, 失败: ${failCount}。\n部分错误:\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? '\n...' : ''}`;
                alertErr(errorMsg);
            }

            clearFileSelection(); // 清除选择
            listFiles(currentPath); // 刷新列表

        } catch (error) {
            alertErr('批量删除过程中发生未知错误: ' + error.message);
        }
    }

    // 批量下载 (简单实现：逐个触发下载)
    function bulkDownloadSelectedFiles() {
        if (selectedFiles.size === 0 || !currentFileManagerServer) {
            alertWarn('请先选择文件');
            return;
        }

        let fileCount = 0;
        selectedFiles.forEach(filename => {
            // 检查是否为文件 (简单检查)
            const card = document.querySelector(`.file-card[data-name="${CSS.escape(filename)}"]`);
            if (card && card.dataset.isDirectory !== 'true') {
                fileCount++;
                const fullPath = currentPath === '/' ? `/${filename}` : `${currentPath}/${filename}`;
                const url = `/api/servers/${currentFileManagerServer.id}/download?path=${encodeURIComponent(fullPath)}`;
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        if (fileCount === 0) {
            alertWarn('请选择至少一个文件进行下载');
        } else {
            alertOk(`已触发下载 ${fileCount} 个文件。浏览器可能会阻止多个下载弹窗，请允许。`);
        }
    }

    // 文件右键菜单事件处理函数 (事件委托)
    function handleFileContextMenu(e) {
        e.preventDefault();

        let targetCard = e.target.closest('.file-card');
        if (!targetCard) return;

        const filename = targetCard.dataset.name;
        // 如果右键点击的文件未被选中，则清空选择并选中它
        if (!selectedFiles.has(filename)) {
            selectedFiles.clear();
            selectedFiles.add(filename);
            lastSelectedFile = filename;
            updateFileCardSelectionUI();
            updateMultiSelectToolbar();
        }
        // 如果已经选中（包括多选），则保持当前选择

        // 更新 selectedFile 为当前右键点击的文件，以便上下文菜单操作针对它
        selectedFile = {
            name: filename,
            isDirectory: targetCard.dataset.isDirectory === 'true',
            // 可以从 dataset 获取其他信息
            size: targetCard.dataset.size,
            lastModified: targetCard.dataset.lastModified,
            permissions: targetCard.dataset.permissions
        };

        // 高亮当前右键点击的卡片 (可选)
        document.querySelectorAll('.file-card').forEach(c => c.classList.remove('context-menu-target'));
        targetCard.classList.add('context-menu-target'); // 需要添加对应 CSS

        const menu = document.getElementById('fileContextMenu');
        menu.style.top = `${e.clientY}px`;
        menu.style.left = `${e.clientX}px`;
        menu.classList.add('show');
    }

    // 显示文件信息 (简单版本，使用 alert)
    function showFileInfo() {
        // 隐藏上下文菜单
        document.getElementById('fileContextMenu').classList.remove('show');

        if (!selectedFile) {
            alertWarn('请先选择一个文件或目录');
            console.warn("showFileInfo called, but selectedFile is null/undefined.");
            return;
        }

        const modal = document.getElementById('fileInfoModal');
        const titleElement = document.getElementById('fileInfoTitle');
        const nameElement = document.getElementById('infoFileName');
        const typeElement = document.getElementById('infoFileType');
        const sizeElement = document.getElementById('infoFileSize');
        const modifiedElement = document.getElementById('infoFileModified');
        const permissionsElement = document.getElementById('infoFilePermissions');

        // 基本的安全检查
        if (!modal || !titleElement || !nameElement || !typeElement || !sizeElement || !modifiedElement || !permissionsElement) {
            alertErr('文件信息模态框元素未找到');
            console.error("File info modal elements not found in DOM.");
            return;
        }

        // 设置模态框标题
        titleElement.textContent = `文件属性: ${selectedFile.name}`;

        // 填充模态框内容
        nameElement.textContent = selectedFile.name || '-';

        typeElement.textContent = selectedFile.isDirectory ? '目录' : '文件';

        if (selectedFile.size !== undefined && selectedFile.size !== null) {
            sizeElement.textContent = formatFileSize(selectedFile.size);
        } else {
            sizeElement.textContent = '未知';
        }

        // --- 修复时间戳显示 ---
        if (selectedFile.lastModified !== undefined && selectedFile.lastModified !== null) {
            let date;
            // 尝试处理不同格式的时间戳
            if (typeof selectedFile.lastModified === 'number') {
                // 假设是毫秒时间戳
                date = new Date(selectedFile.lastModified);
            } else if (typeof selectedFile.lastModified === 'string') {
                // 尝试解析字符串时间戳
                const num = Number(selectedFile.lastModified);
                if (!isNaN(num)) {
                    // 如果字符串能转成数字，假设是毫秒时间戳
                    date = new Date(num);
                } else {
                    // 否则尝试解析 ISO 字符串或其他格式
                    date = new Date(selectedFile.lastModified);
                }
            } else {
                // 其他情况，直接尝试用 Date 构造函数
                date = new Date(selectedFile.lastModified);
            }

            if (date && !isNaN(date.getTime())) {
                modifiedElement.textContent = date.toLocaleString(); // 使用本地化格式
            } else {
                modifiedElement.textContent = `格式无效 (${selectedFile.lastModified})`;
            }
        } else {
            modifiedElement.textContent = '未知';
        }
        // --- /修复时间戳显示 ---

        permissionsElement.textContent = selectedFile.permissions || '未知';

        // 显示模态框
        modal.classList.remove('hidden');
    }

    // 关闭文件信息模态框
    function closeFileInfoModal() {
        const modal = document.getElementById('fileInfoModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 全局点击事件监听器，用于隐藏上下文菜单和处理路径输入
    document.removeEventListener('click', handleGlobalClick); // 移除可能的旧监听器
    document.addEventListener('click', handleGlobalClick);

    function handleGlobalClick(e) {
        // 隐藏上下文菜单 (如果点击的不是菜单本身或文件卡片)
        if (!e.target.closest('.file-context-menu') && !e.target.closest('.file-card')) {
            document.getElementById('fileContextMenu').classList.remove('show');
            // 可选：取消选中文件
            // selectedFile = null;
            // document.querySelectorAll('.file-card').forEach(c => c.classList.remove('selected'));
        }

        // 处理路径输入框失去焦点 (如果点击的不是路径相关元素)
        const pathDisplay = document.getElementById('currentPathDisplay');
        const pathInput = document.getElementById('currentPathInput');
        if (!pathDisplay.contains(e.target) && !pathInput.contains(e.target)) {
            // 如果输入框是可见的，则尝试跳转并隐藏它
            if (!pathInput.classList.contains('hidden')) {
                const newPath = pathInput.value.trim();
                if (newPath && newPath !== currentPath) {
                    listFiles(newPath); // 尝试跳转到新路径
                }
                deactivatePathInput(); // 无论如何都隐藏输入框
            }
        }
    }

    // 路径输入框按键处理
    document.getElementById('currentPathInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const newPath = this.value.trim();
            if (newPath && newPath !== currentPath) {
                listFiles(newPath); // 尝试跳转到新路径
            }
            deactivatePathInput(); // 跳转后隐藏输入框
        } else if (e.key === 'Escape') {
            // ESC 键取消编辑
            deactivatePathInput();
            updatePathDisplay(currentPath); // 恢复显示原始路径
        }
    });

    // 刷新文件管理器
    function refreshFileManager() {
        listFiles(currentPath);
    }

    // 返回上级目录 (保持不变)
    function goToParentDirectory() {
        if (currentPath === '/') return;

        const parts = currentPath.split('/').filter(p => p);
        parts.pop(); // 移除最后一个部分
        const newPath = parts.length > 0 ? '/' + parts.join('/') : '/';

        listFiles(newPath);
    }

    // ===== 文件操作函数 (保持不变或微调) =====

    // 刷新文件页面的服务器列表
    async function refreshFilesPage() {
        const container = document.getElementById('filesServerList');
        container.innerHTML = '<div class="alert info">正在加载服务器列表...</div>';

        try {
            const servers = await fetchServers();

            if (servers.length === 0) {
                container.innerHTML = '<div class="alert warn">暂无服务器配置，请先在 SSH 连接页面添加服务器。</div>';
                return;
            }

            container.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'grid cols-2';

            servers.forEach(server => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-hd">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <i class="fa fa-server"></i>
                            <b>${server.name || `${server.host}:${server.port}`}</b>
                        </div>
                    </div>
                    <div class="card-bd">
                        <div style="margin-bottom: 15px;">
                            <div><strong>地址:</strong> ${server.host}:${server.port}</div>
                            <div><strong>用户:</strong> ${server.username}</div>
                        </div>
                        <div class="text-right">
                            <button class="btn primary" onclick='openFileManagerForServer(${JSON.stringify(server).replace(/'/g, "\\'")})'>
                                <i class="fa fa-folder-open"></i> 管理文件
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            container.appendChild(grid);
        } catch (error) {
            container.innerHTML = `<div class="alert error">加载服务器列表失败: ${error.message}</div>`;
        }
    }

    // 关闭文件管理器
    function closeFileManager() {
        document.getElementById('fileManagerModal').classList.add('hidden');
        currentFileManagerServer = null;
        selectedFile = null;
        selectedFiles.clear(); // 清除多选
        lastSelectedFile = null;
        updateMultiSelectToolbar(); // 隐藏工具栏
        document.getElementById('fileContextMenu').classList.remove('show');
    }

    // 下载选中的文件
    function downloadSelectedFile() {
        if (!selectedFile || !currentFileManagerServer) {
            alertWarn('请先选择一个文件');
            // 隐藏菜单
            document.getElementById('fileContextMenu').classList.remove('show');
            return;
        }

        if (selectedFile.isDirectory) {
            alertWarn('不能下载目录');
            // 隐藏菜单
            document.getElementById('fileContextMenu').classList.remove('show');
            return;
        }

        const fullPath = currentPath === '/' ? `/${selectedFile.name}` : `${currentPath}/${selectedFile.name}`;
        const url = `/api/servers/${currentFileManagerServer.id}/download?path=${encodeURIComponent(fullPath)}`;

        // 创建一个隐藏的下载链接并点击它
        const link = document.createElement('a');
        link.href = url;
        link.download = selectedFile.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // 隐藏菜单
        document.getElementById('fileContextMenu').classList.remove('show');
    }

    // 删除选中的文件/目录
    async function deleteSelectedFile() {
        if (!selectedFile || !currentFileManagerServer) {
            alertWarn('请先选择一个文件或目录');
            // 隐藏菜单
            document.getElementById('fileContextMenu').classList.remove('show');
            return;
        }

        if (!confirm(`确定要删除 "${selectedFile.name}" 吗?`)) {
            // 隐藏菜单
            document.getElementById('fileContextMenu').classList.remove('show');
            return;
        }

        const fullPath = currentPath === '/' ? `/${selectedFile.name}` : `${currentPath}/${selectedFile.name}`;

        try {
            // 注意：这里假设后端 Controller 已经修改为使用 @RequestBody DeleteRequest
            const response = await fetch(`/api/servers/${currentFileManagerServer.id}/file`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path: fullPath,
                    isDirectory: selectedFile.isDirectory
                })
            });

            const result = await response.json();
            if (result.success) {
                alertOk('删除成功');
                listFiles(currentPath); // 刷新当前目录
            } else {
                alertErr('删除失败: ' + result.message);
            }
        } catch (error) {
            alertErr('请求失败: ' + error.message);
        }

        // 隐藏菜单
        document.getElementById('fileContextMenu').classList.remove('show');
    }

    // 重命名选中的文件/目录
    async function renameSelectedFile() {
        if (!selectedFile || !currentFileManagerServer) {
            alertWarn('请先选择一个文件或目录');
            // 隐藏菜单
            document.getElementById('fileContextMenu').classList.remove('show');
            return;
        }

        const newName = prompt('请输入新的名称:', selectedFile.name);
        if (!newName || newName === selectedFile.name) {
            // 隐藏菜单
            document.getElementById('fileContextMenu').classList.remove('show');
            return;
        }

        const oldPath = currentPath === '/' ? `/${selectedFile.name}` : `${currentPath}/${selectedFile.name}`;
        const newPath = currentPath === '/' ? `/${newName}` : `${currentPath}/${newName}`;

        try {
            // 注意：这里假设后端 Controller 已经修改为使用 @RequestBody RenameRequest
            const response = await fetch(`/api/servers/${currentFileManagerServer.id}/rename`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldPath: oldPath,
                    newPath: newPath
                })
            });

            const result = await response.json();
            if (result.success) {
                alertOk('重命名成功');
                listFiles(currentPath); // 刷新当前目录
            } else {
                alertErr('重命名失败: ' + result.message);
            }
        } catch (error) {
            alertErr('请求失败: ' + error.message);
        }

        // 隐藏菜单
        document.getElementById('fileContextMenu').classList.remove('show');
    }

    // 显示上传模态框
    function showUploadModal() {
        if (!currentFileManagerServer) {
            alertErr('未选择服务器');
            return;
        }
        document.getElementById('uploadPath').value = currentPath;
        document.getElementById("uploadModal").classList.remove("hidden");
    }

    // 关闭上传模态框
    function closeUploadModal() {
        document.getElementById('uploadModal').classList.add('hidden');
        document.getElementById('uploadFiles').value = '';
    }

    // 处理文件上传
    async function handleUpload() {
        const fileInput = document.getElementById('uploadFiles');
        const uploadPath = document.getElementById('uploadPath').value;
        const files = fileInput.files;

        if (files.length === 0) {
            alertWarn('请选择要上传的文件');
            return;
        }

        if (!currentFileManagerServer) {
            alertErr('未选择服务器');
            return;
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }
        formData.append('path', uploadPath);

        try {
            const response = await fetch(`/api/servers/${currentFileManagerServer.id}/upload`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                alertOk(`成功上传 ${files.length} 个文件`);
                closeUploadModal();
                listFiles(uploadPath); // 刷新文件列表
            } else {
                alertErr('上传失败: ' + data.message);
            }
        } catch (err) {
            alertErr('请求失败: ' + err.message);
        }
    }

    // --- 在脚本开头或合适位置定义默认设置 ---
    const DEFAULT_TERMINAL_SETTINGS = {
        fontFamily: 'monospace',
        fontSize: 14
    };

    // --- 添加保存和加载设置的函数 ---
    function saveTerminalSettings() {
        const settings = {
            fontFamily: document.getElementById('terminalFontFamily').value,
            fontSize: parseInt(document.getElementById('terminalFontSize').value, 10)
        };
        localStorage.setItem('webssh-terminal-settings', JSON.stringify(settings));
    }

    function loadTerminalSettings() {
        const savedSettings = localStorage.getItem('webssh-terminal-settings');
        let settings;
        if (savedSettings) {
            try {
                settings = JSON.parse(savedSettings);
            } catch (e) {
                console.error("Failed to parse saved terminal settings:", e);
                settings = DEFAULT_TERMINAL_SETTINGS;
            }
        } else {
            settings = DEFAULT_TERMINAL_SETTINGS;
        }
        document.getElementById('terminalFontFamily').value = settings.fontFamily;
        document.getElementById('terminalFontSize').value = settings.fontSize;
        return settings;
    }

    // --- 添加应用设置的函数 ---
    function applyTerminalSettings() {
        saveTerminalSettings(); // 保存到 localStorage
        alertOk('设置已保存。新终端将使用新设置。');
        // 注意：要将设置应用到已存在的终端，需要更新所有 tabs 中的 term.options
        // 这是一个更复杂的操作，通常需要重新创建终端或逐一更新。
        // 这里仅保存设置，供后续新建的终端使用。
        // 如果需要更新现有终端，可以考虑添加一个 "重新加载所有终端" 的功能。
    }

    // 显示新建目录模态框
    function showCreateDirModal() {
        if (!currentFileManagerServer) {
            alertErr('未选择服务器');
            return;
        }
        document.getElementById('newDirName').value = '';
        document.getElementById('createDirModal').classList.remove('hidden');
    }

    // 关闭新建目录模态框
    function closeCreateDirModal() {
        document.getElementById('createDirModal').classList.add('hidden');
    }

    // 创建目录
    async function createDirectory() {
        if (!currentFileManagerServer) {
            alertErr('未选择服务器');
            return;
        }

        const dirName = document.getElementById('newDirName').value.trim();
        if (!dirName) {
            alertWarn('请输入目录名称');
            return;
        }

        const fullPath = currentPath === '/' ? `/${dirName}` : `${currentPath}/${dirName}`;

        try {
            const response = await fetch(`/api/servers/${currentFileManagerServer.id}/mkdir`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: fullPath })
            });

            const result = await response.json();
            if (result.success) {
                alertOk('目录创建成功');
                closeCreateDirModal();
                listFiles(currentPath); // 刷新当前目录
            } else {
                alertErr('创建目录失败: ' + result.message);
            }
        } catch (error) {
            alertErr('请求失败: ' + error.message);
        }
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
        // 恢复主题设置
        const savedTheme = localStorage.getItem('webssh-theme');
        if (savedTheme === 'light') {
            document.body.classList.add('theme-light');
            document.querySelector('.side-actions .btn.ghost i').className = 'fa fa-sun';
        }
        // 恢复背景设置
        const savedBgType = localStorage.getItem('webssh-bg-type') || 'default';
        document.getElementById('backgroundType').value = savedBgType;
        if (savedBgType !== 'default') {
            document.getElementById('backgroundImageRow').style.display = 'grid';
        }
        applyBackgroundSettings(); // 应用背景
        fetchServers();
        refreshFilesPage();
        loadTerminalSettings();
        // 创建默认终端标签
        setTimeout(createNewTab, 500);

        // 为路径显示区域添加点击事件以激活输入框
        document.getElementById('currentPathDisplay').addEventListener('click', activatePathInput);

        // --- 新增：为文件列表容器添加键盘事件监听 (用于 Ctrl+A 全选等) ---
        const fileGridContainer = document.getElementById('fileGridContainer');
        if (fileGridContainer) {
            fileGridContainer.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                    e.preventDefault();
                    // 全选
                    selectedFiles.clear();
                    document.querySelectorAll('#fileList .file-card').forEach(card => {
                        selectedFiles.add(card.dataset.name);
                    });
                    if (selectedFiles.size > 0) {
                        // 设置 lastSelectedFile 为最后一个选中的
                        lastSelectedFile = Array.from(selectedFiles)[selectedFiles.size - 1];
                    }
                    updateFileCardSelectionUI();
                    updateMultiSelectToolbar();
                }
            });
            // 确保容器可以获取焦点
            fileGridContainer.setAttribute('tabindex', '0');
        }
    });

    // 背景类型选择变化事件 ---
    document.getElementById('backgroundType').addEventListener('change', function() {
        const row = document.getElementById('backgroundImageRow');
        if (this.value !== 'default') {
            row.style.display = 'grid';
        } else {
            row.style.display = 'none';
        }
    });

    // ESC键退出全屏
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && isFullscreen) {
            toggleFullscreen();
        }
    });

    // 为路径显示区域添加点击事件以激活输入框
    document.getElementById('currentPathDisplay').addEventListener('click', activatePathInput);
</script>
</body>
</html>